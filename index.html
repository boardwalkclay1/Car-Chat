<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>acar chat â€“ realtime road vibes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS for the map -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root {
      --bg: #05060b;
      --bg-alt: #0b0d16;
      --card: #111525;
      --accent: #ff4b8b;
      --accent-soft: rgba(255, 75, 139, 0.2);
      --text: #f8f9ff;
      --muted: #9ba0c6;
      --border: #252a3f;
      --danger: #ff4b5c;
      --success: #4bffb3;
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-sm: 8px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #151a33 0, #05060b 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app-shell {
      display: grid;
      grid-template-rows: auto 1fr;
      min-height: 100vh;
    }

    header {
      padding: 14px 18px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(90deg, rgba(255, 75, 139, 0.08), transparent);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-badge {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #ffb8da, #ff4b8b);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #05060b;
      font-size: 16px;
      box-shadow: 0 0 25px rgba(255, 75, 139, 0.65);
    }

    .brand-title {
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 14px;
      color: var(--muted);
    }

    .brand-subtitle {
      font-size: 11px;
      color: var(--muted);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 11px;
      color: var(--muted);
      background: rgba(5, 6, 11, 0.9);
    }

    .btn {
      border-radius: 999px;
      border: 1px solid var(--accent);
      background: var(--accent);
      color: #05060b;
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
      box-shadow: 0 0 18px rgba(255, 75, 139, 0.45);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 26px rgba(255, 75, 139, 0.7);
    }

    .btn-outline {
      background: transparent;
      color: var(--accent);
      box-shadow: none;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.4fr);
      gap: 14px;
      padding: 14px;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: radial-gradient(circle at top left, #191e35 0, #05060b 50%);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: 0 0 35px rgba(0, 0, 0, 0.55);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--muted);
    }

    .map-container {
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 1px solid var(--border);
      min-height: 280px;
    }

    #map {
      width: 100%;
      height: 320px;
    }

    @media (max-width: 900px) {
      #map {
        height: 260px;
      }
    }

    .profile-card {
      background: radial-gradient(circle at top, #20253f 0, #05060b 55%);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .profile-header {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .profile-avatar {
      width: 48px;
      height: 48px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #ffb8da, #ff4b8b);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #05060b;
      font-size: 20px;
      flex-shrink: 0;
      border: 2px solid #ffb8da;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-main {
      flex: 1;
    }

    .profile-name {
      font-size: 14px;
      font-weight: 600;
    }

    .profile-car {
      font-size: 12px;
      color: var(--muted);
    }

    .profile-meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    .chip {
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: rgba(5, 6, 11, 0.85);
    }

    .chip.hot {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(255, 75, 139, 0.08);
    }

    .status-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: #18ffa0;
      box-shadow: 0 0 10px rgba(24, 255, 160, 0.9);
    }

    .status-row {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--muted);
    }

    .profile-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 4px;
    }

    @media (max-width: 600px) {
      .profile-form {
        grid-template-columns: 1fr;
      }
    }

    label {
      font-size: 11px;
      color: var(--muted);
      display: block;
      margin-bottom: 3px;
    }

    input[type="text"],
    input[type="url"],
    textarea {
      width: 100%;
      padding: 6px 8px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: rgba(5, 6, 11, 0.9);
      color: var(--text);
      font-size: 12px;
      outline: none;
    }

    input::placeholder,
    textarea::placeholder {
      color: #5d6386;
    }

    textarea {
      resize: vertical;
      min-height: 48px;
    }

    .input-row {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .input-row.full {
      grid-column: 1 / -1;
    }

    .profile-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 4px;
      gap: 8px;
    }

    .chat-card {
      background: radial-gradient(circle at top right, #20253f 0, #05060b 55%);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 10px;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 8px;
      height: 100%;
      max-height: 480px;
    }

    .chat-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      font-size: 12px;
    }

    .chat-badges {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .chat-badge {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .chat-badge.hot {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(255, 75, 139, 0.08);
    }

    .chat-log {
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: rgba(5, 6, 11, 0.85);
      padding: 8px;
      overflow-y: auto;
      font-size: 12px;
    }

    .chat-empty {
      text-align: center;
      color: var(--muted);
      font-size: 11px;
      padding: 12px 6px;
    }

    .msg-row {
      margin-bottom: 7px;
      display: flex;
    }

    .msg-row.me {
      justify-content: flex-end;
    }

    .msg-bubble {
      max-width: 76%;
      padding: 6px 9px;
      border-radius: 11px;
      font-size: 12px;
      line-height: 1.4;
      background: #15182a;
      border: 1px solid var(--border);
    }

    .msg-row.me .msg-bubble {
      background: var(--accent);
      border-color: var(--accent);
      color: #05060b;
    }

    .msg-meta {
      font-size: 10px;
      opacity: 0.8;
      margin-top: 2px;
    }

    .chat-input-row {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 6px;
      align-items: center;
    }

    .emotion-buttons {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .emotion-btn {
      font-size: 11px;
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(5, 6, 11, 0.9);
      color: var(--muted);
      cursor: pointer;
    }

    .emotion-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .chat-input {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chat-input input {
      flex: 1;
    }

    .btn-icon {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      background: var(--accent);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      cursor: pointer;
      color: #05060b;
    }

    .range-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    .range-row input[type="range"] {
      flex: 1;
    }

    footer {
      font-size: 10px;
      color: var(--muted);
      text-align: center;
      padding: 8px;
      border-top: 1px solid var(--border);
      background: rgba(5, 6, 11, 0.96);
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header>
    <div class="brand">
      <div class="brand-badge">a</div>
      <div>
        <div class="brand-title">acar chat</div>
        <div class="brand-subtitle">realtime road vibes Â· global room v1</div>
      </div>
    </div>
    <div class="header-right">
      <div class="pill" id="wsStatus">socket: connectingâ€¦</div>
      <button class="btn btn-outline" id="resetBtn">Reset local data</button>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">road map Â· live radius</div>
          <div class="card-subtitle">
            this room is <strong>global v1</strong>. everyone connected sees each other's markers.
          </div>
        </div>
        <div class="pill" id="radiusLabel">radius: 15 mi</div>
      </div>

      <div class="map-container">
        <div id="map"></div>
      </div>

      <div class="range-row">
        <span>5 mi</span>
        <input type="range" min="5" max="70" step="1" value="15" id="radiusInput" />
        <span>70 mi</span>
      </div>

      <div style="margin-top: 6px; display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn-outline btn" id="locateBtn">Use my location</button>
        <button class="btn-outline btn" id="toggleShareBtn">Share location</button>
        <div class="pill" id="geoStatus">location: idle</div>
      </div>
    </section>

    <section style="display: flex; flex-direction: column; gap: 10px;">
      <div class="profile-card">
        <div class="profile-header">
          <div class="profile-avatar" id="avatarCircle">
            <span id="avatarInitial">?</span>
            <img id="avatarImg" alt="" style="display:none;" />
          </div>
          <div class="profile-main">
            <div class="profile-name" id="profileNameDisplay">guest rider</div>
            <div class="profile-car" id="profileCarDisplay">no car set yet</div>
            <div class="profile-meta-row">
              <div class="status-row">
                <span class="status-dot"></span>
                <span id="profileStatus">local profile â€¢ global room</span>
              </div>
              <div class="chip hot">device-only profile</div>
            </div>
          </div>
        </div>

        <div class="profile-form">
          <div class="input-row">
            <label for="displayName">display name</label>
            <input id="displayName" type="text" placeholder="neon civic, galaxy rider..." />
          </div>
          <div class="input-row">
            <label for="carModel">car + vibe</label>
            <input id="carModel" type="text" placeholder="2018 civic â€¢ midnight stargazer" />
          </div>
          <div class="input-row full">
            <label for="bio">short profile</label>
            <textarea id="bio" placeholder="keep it kind, playful, consent-first."></textarea>
          </div>
        </div>

        <div class="profile-actions">
          <button class="btn-outline btn" id="loadProfileBtn">Load profile</button>
          <button class="btn" id="saveProfileBtn">Save on this device</button>
        </div>
      </div>

      <div class="chat-card">
        <div class="chat-header-row">
          <div>
            <div class="card-title">acar chat Â· global road room</div>
            <div class="card-subtitle">
              everyone connected to this room sees your messages in real time.
            </div>
          </div>
          <div class="chat-badges">
            <div class="chat-badge hot">v1 Â· no blocking, no reporting Â· be kind</div>
          </div>
        </div>

        <div class="chat-log" id="chatLog">
          <div class="chat-empty">
            no road messages yet. say hi, wave, hug, kiss, or flirt respectfully.
          </div>
        </div>

        <div class="chat-input-row">
          <div class="emotion-buttons">
            <button class="emotion-btn" data-emote="ðŸ‘‹ wave">ðŸ‘‹ wave</button>
            <button class="emotion-btn" data-emote="ðŸ˜Š smile">ðŸ˜Š smile</button>
            <button class="emotion-btn" data-emote="ðŸ¤— hug">ðŸ¤— hug</button>
            <button class="emotion-btn" data-emote="ðŸ˜˜ kiss">ðŸ˜˜ kiss</button>
            <button class="emotion-btn" data-emote="ðŸ”¥ flirt">ðŸ”¥ flirt</button>
          </div>
          <div class="chat-input">
            <input id="chatInput" type="text" placeholder="type a road message..." />
          </div>
          <button class="btn-icon" id="sendBtn">âž¤</button>
        </div>
      </div>
    </section>
  </main>

  <footer>
    acar chat v1 Â· realtime global room Â· HTML + WebSocket on Vercel Â· profiles stay on your device only.
  </footer>
</div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
  const PROFILE_KEY = "acar_profile_v1";
  const CHAT_KEY = "acar_chat_log_v1";

  const wsStatus = document.getElementById("wsStatus");
  const resetBtn = document.getElementById("resetBtn");

  const displayNameInput = document.getElementById("displayName");
  const carModelInput = document.getElementById("carModel");
  const bioInput = document.getElementById("bio");

  const profileNameDisplay = document.getElementById("profileNameDisplay");
  const profileCarDisplay = document.getElementById("profileCarDisplay");
  const profileStatus = document.getElementById("profileStatus");
  const avatarCircle = document.getElementById("avatarCircle");
  const avatarInitial = document.getElementById("avatarInitial");
  const avatarImg = document.getElementById("avatarImg");

  const saveProfileBtn = document.getElementById("saveProfileBtn");
  const loadProfileBtn = document.getElementById("loadProfileBtn");

  const chatLog = document.getElementById("chatLog");
  const chatInput = document.getElementById("chatInput");
  const sendBtn = document.getElementById("sendBtn");
  const emotionButtons = document.querySelectorAll(".emotion-btn");

  const radiusInput = document.getElementById("radiusInput");
  const radiusLabel = document.getElementById("radiusLabel");
  const locateBtn = document.getElementById("locateBtn");
  const toggleShareBtn = document.getElementById("toggleShareBtn");
  const geoStatus = document.getElementById("geoStatus");

  const myId = "u-" + Math.random().toString(36).slice(2, 10);

  let ws = null;
  let connected = false;
  let sharingLocation = false;
  let myLocation = null;

  let map = L.map("map", {
    center: [33.749, -84.388],
    zoom: 11,
    zoomControl: false,
  });
  L.control.zoom({ position: "bottomright" }).addTo(map);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap",
  }).addTo(map);

  const markers = new Map();

  function milesToMeters(mi) {
    return mi * 1609.34;
  }

  function updateRadiusLabel() {
    radiusLabel.textContent = "radius: " + radiusInput.value + " mi";
  }
  radiusInput.addEventListener("input", updateRadiusLabel);
  updateRadiusLabel();

  function setWsStatus(text, state) {
    wsStatus.textContent = "socket: " + text;
    if (state === "ok") {
      wsStatus.style.color = "#4bffb3";
      wsStatus.style.borderColor = "#4bffb3";
    } else if (state === "err") {
      wsStatus.style.color = "#ff4b5c";
      wsStatus.style.borderColor = "#ff4b5c";
    } else {
      wsStatus.style.color = "#9ba0c6";
      wsStatus.style.borderColor = "#252a3f";
    }
  }

  function setGeo(text, state) {
    geoStatus.textContent = text;
    if (state === "ok") {
      geoStatus.style.color = "#4bffb3";
      geoStatus.style.borderColor = "#4bffb3";
    } else if (state === "err") {
      geoStatus.style.color = "#ff4b5c";
      geoStatus.style.borderColor = "#ff4b5c";
    } else {
      geoStatus.style.color = "#9ba0c6";
      geoStatus.style.borderColor = "#252a3f";
    }
  }

  function getProfile() {
    return {
      id: myId,
      displayName: displayNameInput.value.trim() || "guest rider",
      carModel: carModelInput.value.trim() || "",
      bio: bioInput.value.trim() || "",
    };
  }

  function applyProfileToUI(profile) {
    profileNameDisplay.textContent = profile.displayName || "guest rider";
    profileCarDisplay.textContent = profile.carModel || "no car set yet";
    const initial = (profile.displayName || "g").trim().charAt(0).toUpperCase();
    avatarInitial.textContent = initial || "?";
    avatarImg.style.display = "none";
  }

  function saveProfile() {
    const p = getProfile();
    localStorage.setItem(PROFILE_KEY, JSON.stringify(p));
    applyProfileToUI(p);
    profileStatus.textContent = "profile saved locally â€¢ global room";
  }

  function loadProfile() {
    try {
      const raw = localStorage.getItem(PROFILE_KEY);
      if (!raw) return;
      const p = JSON.parse(raw);
      displayNameInput.value = p.displayName || "";
      carModelInput.value = p.carModel || "";
      bioInput.value = p.bio || "";
      applyProfileToUI(p);
    } catch (e) {}
  }

  saveProfileBtn.addEventListener("click", saveProfile);
  loadProfileBtn.addEventListener("click", loadProfile);
  resetBtn.addEventListener("click", () => {
    localStorage.removeItem(PROFILE_KEY);
    localStorage.removeItem(CHAT_KEY);
    location.reload();
  });

  function renderChat(messages) {
    chatLog.innerHTML = "";
    if (!messages.length) {
      const empty = document.createElement("div");
      empty.className = "chat-empty";
      empty.textContent = "no road messages yet. be the first.";
      chatLog.appendChild(empty);
      return;
    }
    messages.forEach((m) => {
      const row = document.createElement("div");
      row.className = "msg-row" + (m.senderId === myId ? " me" : "");
      const bubble = document.createElement("div");
      bubble.className = "msg-bubble";
      const t = document.createElement("div");
      t.textContent = m.text;
      const meta = document.createElement("div");
      meta.className = "msg-meta";
      const time = new Date(m.ts || Date.now()).toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit",
      });
      meta.textContent = (m.displayName || "rider") + " â€¢ " + time;
      bubble.appendChild(t);
      bubble.appendChild(meta);
      row.appendChild(bubble);
      chatLog.appendChild(row);
    });
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function loadChat() {
    try {
      const raw = localStorage.getItem(CHAT_KEY);
      if (!raw) return [];
      return JSON.parse(raw);
    } catch (e) {
      return [];
    }
  }

  function saveChat(messages) {
    localStorage.setItem(CHAT_KEY, JSON.stringify(messages));
    renderChat(messages);
  }

  let chatMessages = loadChat();
  renderChat(chatMessages);

  function pushLocalMessage(msg) {
    chatMessages.push(msg);
    if (chatMessages.length > 200) chatMessages.shift();
    saveChat(chatMessages);
  }

  function sendChat(text) {
    const trimmed = text.trim();
    if (!trimmed || !connected) return;
    const p = getProfile();
    const msg = {
      type: "chat",
      payload: {
        text: trimmed,
        senderId: myId,
        displayName: p.displayName,
      },
    };
    ws.send(JSON.stringify(msg));
    pushLocalMessage({
      text: trimmed,
      senderId: myId,
      displayName: p.displayName,
      ts: Date.now(),
    });
    chatInput.value = "";
  }

  sendBtn.addEventListener("click", () => sendChat(chatInput.value));
  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendChat(chatInput.value);
    }
  });
  emotionButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      sendChat(btn.getAttribute("data-emote") || btn.textContent.trim());
    });
  });

  function connectSocket() {
    try {
      const roomId = "global";
      let wsUrl = (location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws?room=" + roomId;
      ws = new WebSocket(wsUrl);
      setWsStatus("connectingâ€¦", "idle");

      ws.onopen = () => {
        connected = true;
        setWsStatus("connected to global", "ok");
      };

      ws.onclose = () => {
        connected = false;
        setWsStatus("disconnected â€¢ retryingâ€¦", "err");
        setTimeout(connectSocket, 2000);
      };

      ws.onerror = () => {
        connected = false;
        setWsStatus("error â€¢ retryingâ€¦", "err");
        try { ws.close(); } catch {}
      };

      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          if (msg.type === "chat") {
            const p = msg.payload || {};
            pushLocalMessage({
              text: p.text || "",
              senderId: p.senderId,
              displayName: p.displayName,
              ts: msg.ts,
            });
          }
          if (msg.type === "location") {
            const p = msg.payload || {};
            const { userId, lat, lng, radiusMiles, profile } = p;
            if (!userId || userId === myId) return;
            let marker = markers.get(userId);
            if (!marker) {
              marker = L.circle([lat, lng], {
                radius: milesToMeters(radiusMiles || 15),
                color: "#ff4b8b",
                fillColor: "#ff4b8b",
                fillOpacity: 0.15,
              }).addTo(map);
              markers.set(userId, marker);
            } else {
              marker.setLatLng([lat, lng]);
              marker.setRadius(milesToMeters(radiusMiles || 15));
            }
            const label = (profile && profile.displayName) || "rider";
            marker.bindTooltip(label, { permanent: false });
          }
        } catch (e) {}
      };
    } catch (e) {
      setWsStatus("failed to create socket", "err");
    }
  }

  function shareLocation() {
    if (!connected) {
      setGeo("socket not connected", "err");
      return;
    }
    if (!myLocation) {
      setGeo("no location fix yet", "err");
      return;
    }
    const radiusMiles = Number(radiusInput.value) || 15;
    const profile = getProfile();
    const msg = {
      type: "location",
      payload: {
        userId: myId,
        lat: myLocation.lat,
        lng: myLocation.lng,
        radiusMiles,
        profile,
      },
    };
    ws.send(JSON.stringify(msg));
    setGeo("location shared to global room", "ok");
  }

  locateBtn.addEventListener("click", () => {
    if (!navigator.geolocation) {
      setGeo("geolocation not supported", "err");
      return;
    }
    setGeo("requesting gpsâ€¦", "idle");
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const { latitude, longitude } = pos.coords;
        myLocation = { lat: latitude, lng: longitude };
        map.setView([latitude, longitude], 12);
        setGeo("location ready", "ok");
        if (sharingLocation) shareLocation();
      },
      () => {
        setGeo("location denied or failed", "err");
      }
    );
  });

  toggleShareBtn.addEventListener("click", () => {
    sharingLocation = !sharingLocation;
    if (sharingLocation) {
      toggleShareBtn.textContent = "Stop sharing location";
      shareLocation();
    } else {
      toggleShareBtn.textContent = "Share location";
      setGeo("not sharing location", "idle");
    }
  });

  function init() {
    loadProfile();
    connectSocket();
  }

  init();
</script>
</body>
</html>
